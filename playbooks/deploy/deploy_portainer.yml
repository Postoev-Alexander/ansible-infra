---
- name: Deploy Portainer Stack to Swarm
  hosts: portainer_vps
  become: yes

  roles:
    - docker_compose  

  tasks:
    - name: Ensure Docker Swarm is initialized
      community.docker.docker_swarm:
        state: present
      register: swarm_result

    - name: Create Portainer stack file from template
      copy:
        dest: /root/portainer-agent-stack.yml
        content: |
          version: '3.2'
          services:
            agent:
              image: portainer/agent:2.21.4
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - /var/lib/docker/volumes:/var/lib/docker/volumes
              networks:
                - agent_network
              deploy:
                mode: global
                placement:
                  constraints: [node.platform.os == linux]

            portainer:
              image: portainer/portainer-ce:2.21.4
              command: -H tcp://tasks.agent:9001 --tlsskipverify
              ports:
                - "9443:9443"
                - "9000:9000"
                - "8000:8000"
              volumes:
                - portainer_data:/data
              networks:
                - agent_network
              deploy:
                mode: replicated
                replicas: 1
                placement:
                  constraints: [node.role == manager]

          networks:
            agent_network:
              driver: overlay
              attachable: true

          volumes:
            portainer_data:

    - name: Deploy Portainer stack
      community.docker.docker_stack:
        name: portainer
        state: present
        compose:
          - /root/portainer-agent-stack.yml
      tags:
        - deploy