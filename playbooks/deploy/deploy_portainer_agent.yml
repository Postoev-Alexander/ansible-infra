---
- name: Deploy Independent Swarm and Portainer Agent
  hosts: teamcity_vps
  become: yes

  roles:
    - docker_compose  

  tasks:
    - name: Ensure Python dependencies for docker_stack are installed
      ansible.builtin.apt:
        name:
          - python3-jsondiff
          - python3-yaml
        state: present
        update_cache: yes

    - name: Initialize Independent Docker Swarm on TeamCity VPS
      community.docker.docker_swarm:
        state: present
      register: swarm_result

    - name: Create Portainer Agent stack file
      copy:
        dest: /root/portainer-agent-only.yml
        content: |
          version: '3.2'
          services:
            agent:
              image: portainer/agent:2.21.4
              environment:
                - AGENT_CLUSTER_ADDR=tasks.agent
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - /var/lib/docker/volumes:/var/lib/docker/volumes
              networks:
                - agent_network
              ports:
                - "9001:9001"
              deploy:
                mode: global
                placement:
                  constraints: [node.platform.os == linux]

          networks:
            agent_network:
              driver: overlay
              attachable: true

    - name: Deploy Portainer Agent stack
      community.docker.docker_stack:
        name: portainer_agent
        state: present
        compose:
          - /root/portainer-agent-only.yml
      tags:
        - deploy