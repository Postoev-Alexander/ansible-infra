services:
  mongo:
    image: mongo:{{ mongodb_version }}
    container_name: {{ project_name }}_mongo
    restart: unless-stopped
    command: mongod --replSet {{ mongo_replicaset_name }} --oplogSize 128 --keyFile /etc/mongo/mongo.key --auth
    volumes:
      - mongodb_data:/data/db
      - /opt/rocketchat/mongo_key/mongo.key:/etc/mongo/mongo.key:ro
    environment:
      - MONGO_INITDB_ROOT_USERNAME={{ mongo_user }}
      - MONGO_INITDB_ROOT_PASSWORD={{ mongo_password }}
    healthcheck:
      test: |
        mongosh --host 127.0.0.1 -u {{ mongo_user }} -p '{{ mongo_password }}' --authenticationDatabase admin --quiet --eval "quit(db.hello().isWritablePrimary ? 0 : 1)"
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 60s
    networks:
      - rocketchat_internal

  rocketchat:
    image: rocketchat/rocket.chat:{{ rocketchat_version }}
    container_name: {{ project_name }}_app
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rocketchat.rule=Host(`{{ rocketchat_subdomain }}.{{ main_domain }}`)"
      - "traefik.http.routers.rocketchat.entrypoints=web,websecure"
      - "traefik.http.routers.rocketchat.tls=true"
      - "traefik.http.routers.rocketchat.tls.certresolver=mytlschallenge"
      - "traefik.http.services.rocketchat.loadbalancer.server.port=3000"
    environment:
      - PORT=3000
      - ROOT_URL=https://{{ rocketchat_subdomain }}.{{ main_domain }}
      - MONGO_URL=mongodb://{{ mongo_user }}:{{ mongo_password | urlencode }}@mongo:27017/rocketchat?replicaSet={{ mongo_replicaset_name }}
      # Мы убрали REPLICA_SET_INIT и вернули отдельный контейнер для инициализации
      - FileUpload_Storage_Type=GridFS
    depends_on:
      mongo:
        condition: service_healthy
    volumes:
      - rocketchat_uploads:/app/uploads
    networks:
      - rocketchat_internal
      - {{ traefik_docker_network_name }}

  # --- ФИНАЛЬНОЕ ИЗМЕНЕНИЕ ЗДЕСЬ ---
  mongo-init-replica:
    image: mongo:{{ mongodb_version }}
    container_name: {{ project_name }}_mongo_init
    # Используем формат списка для команды - это самый надежный способ
    command:
      - sh
      - -c
      - |
        echo "Waiting 30s for MongoDB to be ready before initiating replica set..."
        sleep 30
        echo "Initiating replica set..."
        mongosh --host mongo:27017 -u {{ mongo_user }} -p '{{ mongo_password }}' --authenticationDatabase admin --eval '
          try {
            rs.initiate({
              _id: "{{ mongo_replicaset_name }}",
              members: [ { _id: 0, host: "mongo:27017" } ]
            });
            print("Replica set initiated.");
          } catch (e) {
            if (e.codeName === "AlreadyInitialized") {
              print("Replica set already initiated.");
            } else {
              printjson(e);
              quit(1);
            }
          }
        '
    depends_on:
      - mongo
    networks:
      - rocketchat_internal

volumes:
  mongodb_data:
    name: {{ project_name }}_mongodb_data
  rocketchat_uploads:
    name: {{ project_name }}_uploads_data

networks:
  rocketchat_internal:
    internal: true
  {{ traefik_docker_network_name }}:
    external: true