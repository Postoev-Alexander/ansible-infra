---
- name: Deploy Portainer Stack to Swarm
  hosts: portainer
  become: yes

  roles:
    - docker_compose  

  tasks:
    - name: Ensure Python dependencies for docker_stack are installed
      ansible.builtin.apt:
        name:
          - python3-jsondiff
          - python3-yaml
        state: present
        
    - name: Ensure Docker Swarm is initialized
      community.docker.docker_swarm:
        state: present
      register: swarm_result

    - name: Ensure stack directory exists
      ansible.builtin.file:
        path: "{{ portainer_stack_dir }}"
        state: directory
        mode: '0755'

    - name: Create Portainer stack file from template
      copy:
        dest: "{{ portainer_stack_file }}"
        content: |
          version: '3.2'
          services:
            agent:
              image: portainer/agent:{{ portainer_version }}
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - /var/lib/docker/volumes:/var/lib/docker/volumes
              networks:
                - agent_network
              deploy:
                mode: global
                placement:
                  constraints: [node.platform.os == linux]

            portainer:
              image: portainer/portainer-ce:{{ portainer_version }}
              command: -H tcp://tasks.agent:9001 --tlsskipverify
              ports:
                - "9443:9443"
                - "9000:9000"
                - "8000:8000"
              volumes:
                - portainer_data:/data
              networks:
                - agent_network
              deploy:
                mode: replicated
                replicas: 1
                placement:
                  constraints: [node.role == manager]

          networks:
            agent_network:
              driver: overlay
              attachable: true

          volumes:
            portainer_data:

    - name: Deploy Portainer stack
      community.docker.docker_stack:
        name: "{{ stack_name }}"
        state: present
        compose:
          - "{{ portainer_stack_file }}"
      tags:
        - deploy